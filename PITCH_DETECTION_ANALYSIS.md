# 피치 감지 문제 분석 보고서

## 🔍 발견된 문제점

### 1. **2000Hz (시6) 잘못 감지**
- **증상**: 2000Hz가 자주 감지됨 (실제 목소리 범위: 80-800Hz)
- **원인**: Autocorrelation 알고리즘이 하모닉(배음)이나 노이즈를 기본 주파수로 오인
- **영향**: 극단적인 값 변화 (4800센트 차이)

### 2. **극단적인 값 변화 패턴**
```
시6 (2000.0Hz) ↔ 시2 (125.0Hz) - 4800센트 차이
시6 (2000.0Hz) ↔ 레5 (578.3Hz) - 2148센트 차이
시6 (2000.0Hz) ↔ 시2 (122.8Hz) - 4831센트 차이
```

### 3. **짧은 시간 간격에 급격한 변화**
- 0.007초 ~ 0.233초 사이에 극단적인 변화
- 실제 사람의 목소리는 이렇게 빠르게 변할 수 없음

## 📊 로그 분석 결과

### 튀는 값 감지 사례:
1. **28.43초**: 시6 (2000.0Hz) → 시2 (125.0Hz) - 4800센트, 0.233초 간격
2. **28.45초**: 시2 (125.0Hz) → 솔2 (100.8Hz) - 371.8센트, 0.024초 간격
3. **29.32초**: 라2 (111.4Hz) → 시6 (2000.0Hz) - 4999.9센트, 0.020초 간격
4. **29.33초**: 시6 (2000.0Hz) → 시2 (122.8Hz) - 4831.3센트, 0.017초 간격
5. **29.34초**: 시2 (122.8Hz) → 시6 (2000.0Hz) - 4831.3센트, 0.007초 간격 ⚠️
6. **29.36초**: 시6 (2000.0Hz) → 시2 (121.8Hz) - 4844.5센트, 0.020초 간격
7. **29.62초**: 시2 (124.4Hz) → 시6 (2000.0Hz) - 4809.0센트, 0.020초 간격
8. **29.80초**: 시6 (2000.0Hz) → 레5 (578.3Hz) - 2148.1센트, 0.164초 간격
9. **29.82초**: 레5 (578.3Hz) → 시3 (243.7Hz) - 1496.4센트, 0.021초 간격
10. **29.84초**: 시3 (243.7Hz) → 라#2 (118.2Hz) - 1251.9센트, 0.020초 간격

## 🔬 근본 원인 분석

### 1. **Autocorrelation 알고리즘의 한계**
- **하모닉 오인**: 실제 주파수의 배음(2배, 3배 등)을 기본 주파수로 잘못 감지
- **2000Hz 상한선**: `detectPitchAutocorrelation` 함수의 최대 주파수 범위가 2000Hz로 설정되어 있음
- **Pearson correlation 임계값**: 0.3으로 설정되어 있어 노이즈도 감지할 수 있음

### 2. **스무딩 부족**
- **SMOOTHING_FACTOR = 0.3**: 현재 스무딩이 약함 (30%만 새 값 반영)
- **튀는 값 필터링 없음**: 이전 값과의 차이가 크더라도 그대로 반영됨

### 3. **유효성 검증 부족**
- **주파수 범위 체크**: 80-2000Hz 범위는 너무 넓음 (실제 목소리: 80-800Hz)
- **변화율 제한 없음**: 이전 값과의 차이에 대한 제한이 없음

## 💡 해결 방안 (제안)

### 1. **주파수 범위 제한**
```javascript
// 현재: 80-2000Hz
// 제안: 80-800Hz (실제 목소리 범위)
if (detectedFreq >= 80 && detectedFreq <= 800) {
    return detectedFreq;
}
```

### 2. **변화율 제한 (Outlier 필터링)**
```javascript
// 이전 값과의 차이가 200센트 이상이면 무시
const centsDiff = Math.abs(1200 * Math.log2(detectedFreq / lastDetectedPitch));
if (centsDiff > 200) {
    return null; // 튀는 값 무시
}
```

### 3. **스무딩 강화**
```javascript
// 현재: SMOOTHING_FACTOR = 0.3
// 제안: SMOOTHING_FACTOR = 0.1 (더 부드럽게)
const SMOOTHING_FACTOR = 0.1;
```

### 4. **중앙값 필터 (Median Filter)**
```javascript
// 최근 N개 값의 중앙값 사용 (튀는 값 제거)
const recentPitches = []; // 최근 5개 값 저장
recentPitches.push(detectedFreq);
if (recentPitches.length > 5) recentPitches.shift();
const medianPitch = getMedian(recentPitches);
```

### 5. **Autocorrelation 임계값 조정**
```javascript
// 현재: bestCorrelation > 0.3
// 제안: bestCorrelation > 0.5 (더 엄격하게)
if (bestPeriod > 0 && bestCorrelation > 0.5) {
    // ...
}
```

## 📈 예상 효과

- **2000Hz 잘못 감지**: 80-800Hz 범위 제한으로 해결
- **튀는 값**: 변화율 제한 + 중앙값 필터로 해결
- **부드러운 UI**: 스무딩 강화로 해결

## 🎯 우선순위

1. **높음**: 주파수 범위 제한 (80-800Hz)
2. **높음**: 변화율 제한 (200센트 이상 무시)
3. **중간**: 스무딩 강화
4. **낮음**: 중앙값 필터 (성능 고려)

